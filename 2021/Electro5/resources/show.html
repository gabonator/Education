<body bgcolor=black>
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js"></script>

<table><tr><td>
<canvas id="canvas" style="border:8px solid #000000; width:640px; height:320; overflow:right;"></canvas>
</td><td>
</td></tr></table>
<pre style="width:500px; position:absolute; right:0px; top:0px; background:#f0f0f0" id="pre1"><code id="code1" class="language-cpp"></code></pre>

<script>
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext('2d');
canvas.width = 640;
canvas.height = 320;

function showPixel(_x, _y)
{
  var dx = _x < 64 ? 30 : -30;
  var dy = _y < 32 ? 10 : -10;

  x = _x * 5 + 2;
  y = _y * 5 + 2;
  ctx.strokeStyle = "#ff5555";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x+dx, y+dy);
  ctx.stroke();
  ctx.font = "20px Arial";
  ctx.fillStyle = "#ff5555";
  ctx.textAlign = dx < 0 ? "right" : "left";
  ctx.fillText("("+_x+", "+_y+")", x+dx, y+dy);
}

function draw(buf)
{
  ctx.fillStyle = "#000000";
  ctx.fillRect(0, 0, 1000, 1000);
  for (var y=0; y<64; y++)
    for (var x=0; x<128; x++)
    {
      var page = Math.floor(y/8);
      var index = page*128+x;
      var bit = y%8;
      var dword = buf ? buf[Math.floor(index/4)] : 0;
      var byte = (dword >> (((index&3))*8) ) & 0xff;
      var pix = (byte >> (bit)) & 1;
      ctx.fillStyle = pix ? "#d0d0d0" : "#202020";
      ctx.fillRect(x*5, y*5, 4, 4);
    }
}

function parse()
{
  var ranges = [];
  var current = 0;
  var p = document.querySelector("#pre1").childNodes[0].childNodes;
  for (var i=0; i<p.length; i++)
  {
    var text = p[i].nodeValue;
    if (text && text.indexOf("SYNC") != -1)
    {
      var range = new Range();

      var epos = text.indexOf("SYNC") -1;
      while (epos > 0 && p[i].nodeValue[epos] == ' ')
        epos--;
      range.setEnd(p[i], epos+1);

      var tokenRange = new Range();
      tokenRange.setStart(p[i], text.indexOf("SYNC"));
      tokenRange.setEnd(p[i], text.indexOf("SYNC")+4);
      tokenRange.deleteContents();

      for (var j=i-1; j>=0; j--)
      {
        var bpos = p[j].nodeValue ? p[j].nodeValue.lastIndexOf("\n") : -1;
        if (bpos == -1)
          continue;

        bpos++;
        while (p[j].nodeValue[bpos] == ' ')
          bpos++;

        range.setStart(p[j], bpos);
        ranges.push(range);
        break;
      }
    }
  }
  return ranges;
}

function drawRange(r)
{
  document.getSelection().removeAllRanges();
  document.getSelection().addRange(r);

  var matches = r.toString().match("\\((\\d+)\\s*,\\s*(\\d+)");
  if (matches)
  {
    showPixel(matches[1], matches[2]);
  }
}


draw(null);

var index = 0;
var obj;
var ranges = [];
var aux;
var anim = true;
var screens;

var animInterval;

function useCode(code)
{
  if (typeof(hljs) == "undefined")
    return;
  aux = hljs.highlight(code, {language:"cpp"});
  document.querySelector("#code1").innerHTML = aux.value;
  ranges = parse();
}

function runAnim()
{
  animInterval = setInterval(() =>
  {
    draw(screens[index]);
    if (index < ranges.length)
      drawRange(ranges[index]);    
    if (++index >= screens.length) 
      index = 0;
  }, 1000);
}

window.addEventListener('keydown', function(event) {
  const key = event.key;
  if (key == "ArrowUp" && index > 0)
  {
    index--;
    clearInterval(animInterval);

    draw(screens[index]);
    if (index < ranges.length)
      drawRange(ranges[index]);
  }  
  if (key == "ArrowDown" && index < screens.length-1)
  {
    index++;
    clearInterval(animInterval);

    draw(screens[index]);
    if (index < ranges.length)
      drawRange(ranges[index]);
  }  
});

function loadScriptHtml(url)
{
  return new Promise( (resolve, reject) =>
  {
    if (window._callback)
      throw "multiple callbacks";

    window._callback = (data) => {
      resolve(data);
      delete window._callback;
    };

    var script = document.createElement('script');
    script.id = "remote_script";
    script.type = 'text/javascript';
    script.src = url;
    var head = document.getElementsByTagName('head')[0];

    for (var i=0; i<head.childNodes.length; i++)
    {
      if ( head.childNodes[i].nodeName == "SCRIPT" && head.childNodes[i].id == "remote_script" )
      {
        head.removeChild(head.childNodes[i]);
        break;
      }
    }

    head.appendChild(script);
  });
}
var hash = document.location.hash;
var script = "colors.js";

if (hash.substr(0, 1) == "#")
  script = hash.substr(1);

window.addEventListener('load', function(event) {
  loadScriptHtml(script).then(data=>
  {
    screens = data.screens;
    useCode(data.code);
    runAnim();
  });

});


</script>